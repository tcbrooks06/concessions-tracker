<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Concessions Tracker</title>
<style>
  :root{
    --bg: #f7f7f9;
    --card: #ffffff;
    --text: #121212;
    --muted:#666666;
    --border:#dcdde3;

    --green-b:#00B32A;
    --yellow-b:#FFEA00;
    --red-b:#D60F0F;

    --green-bg: rgba(0, 179, 42, 0.12);
    --yellow-bg: rgba(255, 234, 0, 0.12);
    --red-bg: rgba(214, 15, 15, 0.12);

    --gap: 14px;
    --radius:18px;
    --brand:#221e91;
    --brand-dark:#0d1563;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Open Sans", Arial, sans-serif;
    background: var(--bg); color: var(--text);
  }
  header{
    position:sticky; top:0; z-index:10;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 10px 14px;
  }
  .brandrow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .title{font-size:24px; font-weight:800; color: var(--brand); letter-spacing:.2px;}
  .right{display:flex; align-items:center; gap:8px}
  .tabs{display:flex; gap:8px}
  .tab{ padding:8px 14px; border:1px solid var(--border); border-radius:999px; background:var(--card); color:#222; font-weight:700; }
  .tab.active{ background: var(--brand-dark); color: #fff; border-color: var(--brand-dark); }

  .grid{ padding: 14px; display:grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); max-width: 980px; margin: 0 auto; }
  @media (min-width:560px){ .grid{ grid-template-columns: repeat(3, 1fr);} }

  .tile{ position:relative; background: var(--card); border-radius: var(--radius); padding:16px 14px 18px; min-height: 240px; border:2px solid var(--border); user-select:none; touch-action: manipulation; transition: transform .02s ease; }
  .tile:active{ transform: translateY(1px) }
  .tile .icon{ font-size:64px; line-height:1; margin-top:6px;}
  .tile .label{ margin-top:10px; font-weight:800; color: var(--brand); font-size:20px;}
  .tile .hint{ font-size:12px; color: var(--muted); margin-top:4px; }
  .badge{ position:absolute; top:10px; right:12px; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--text); }
  .status-chip{ position:absolute; top:10px; left:12px; font-size:12px; font-weight:800; padding:5px 10px; border-radius:999px; border:1px solid; background:var(--card); color: #000; }

  .status-green { border-color: var(--green-b); background: var(--green-bg); }
  .status-yellow{ border-color: var(--yellow-b); background: var(--yellow-bg); }
  .status-red   { border-color: var(--red-b); background: var(--red-bg); }
  .status-green .status-chip{ border-color:var(--green-b); }
  .status-yellow .status-chip{ border-color:var(--yellow-b); }
  .status-red .status-chip{ border-color:var(--red-b); }
  .status-green .badge{ border-color:var(--green-b); }
  .status-yellow .badge{ border-color:var(--yellow-b); }
  .status-red .badge{ border-color:var(--red-b); }

  .reset{ position:absolute; bottom:10px; right:12px; font-size:12px; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:4px 7px; color:var(--text); }

  .footer-note{padding:10px 14px 30px; text-align:center; color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="brandrow">
      <div class="title">Concessions Tracker</div>
      <div class="right">
        <div class="tabs" id="sideTabs" role="tablist" aria-label="Choose side">
          <button class="tab active" data-side="home" role="tab" aria-selected="true">Home</button>
          <button class="tab" data-side="visitor" role="tab" aria-selected="false">Away</button>
        </div>
      </div>
    </div>
  </header>

  <main id="screenTiles" class="grid" aria-live="polite"></main>

  <div class="footer-note">Tap a tile to cycle: Green → Yellow → Red → Green • ⟳ Reset</div>

<!-- Firebase + App Code -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  // Optional: import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

  // Your Firebase config (from console)
  const firebaseConfig = {
    apiKey: "AIzaSyDkWwFDPliysrHV1Bslymyl-QG5-_NAJxo",
    authDomain: "concession-tracker.firebaseapp.com",
    projectId: "concession-tracker",
    storageBucket: "concession-tracker.firebasestorage.app",
    messagingSenderId: "677157756313",
    appId: "1:677157756313:web:6622355b22c8ba4f5d0708",
    measurementId: "G-2CF1ZGZQ5C"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  try { await enableIndexedDbPersistence(db); } catch(e) {}

  const url = new URL(window.location.href);
  const SESSION = (url.searchParams.get('s') || 'demo').toLowerCase();
  const sessionRef = doc(db, 'sessions', SESSION);

  const ITEMS = [
    {key:'hamburger',       label:'Hamburger',      icon:'🍔'},
    {key:'cheeseburger',    label:'Cheeseburger',   icon:'🍔'},
    {key:'hot_dog',         label:'Hot Dog',        icon:'🌭'},
    {key:'chicken_sandwich',label:'Chicken Sandwich',  icon:'🥪'},
    {key:'drumstick',       label:'Chicken Tenders',    icon:'🍗'},
    {key:'fries',           label:'Fries',          icon:'🍟'}
  ];
  const SIDES = ['home','visitor'];
  const STORAGE_KEY = 'concessions_state_simple_sync_v1_' + SESSION;

  const tilesScreen = document.getElementById('screenTiles');
  const sideTabs = document.getElementById('sideTabs');

  function createDefaultState(){
    const perSide = {}; SIDES.forEach(s=>{ perSide[s] = {}; ITEMS.forEach(i=>{ perSide[s][i.key] = { status:'green', ts: null }; }); });
    return { activeSide:'home', sides: perSide };
  }
  function saveLocal(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null; } }
  function upgradeState(s){
    let changed = false;
    SIDES.forEach(side=>{
      if(!s.sides[side]) { s.sides[side] = {}; changed = true; }
      ITEMS.forEach(it=>{
        if(!s.sides[side][it.key]){ s.sides[side][it.key] = { status:'green', ts:null }; changed = true; }
      });
    });
    if(changed) { saveLocal(s); if (typeof queueRemoteSave === 'function') queueRemoteSave(); }
    return s;
  }
  let state = loadLocal() || createDefaultState();
  upgradeState(state);

  function cycleStatus(current){ return current==='green' ? 'yellow' : current==='yellow' ? 'red' : 'green'; }
  function minutesSince(ts){ if(!ts) return '—'; const m=Math.floor((Date.now()-ts)/60000); return m<=0? 'Just now' : (m===1? '1 min ago' : `${m} min ago`);}  
  function statusChipText(st){ return st==='green' ? 'Good' : st==='yellow' ? 'Low' : 'Need'; }

  sideTabs.addEventListener('click', (e)=>{
    if(e.target.matches('.tab')){
      const side = e.target.dataset.side;
      state.activeSide = side;
      [...sideTabs.querySelectorAll('.tab')].forEach(t=>{
        t.classList.toggle('active', t.dataset.side===side);
        t.setAttribute('aria-selected', t.dataset.side===side ? 'true' : 'false');
      });
      showTiles();
      queueRemoteSave();
      saveLocal(state);
    }
  });

  function showTiles(){
    tilesScreen.innerHTML = '';
    const side = state.activeSide;
    ITEMS.forEach(item=>{
      const rec = state.sides[side][item.key];
      const tile = document.createElement('button');
      tile.className = `tile status-${rec.status}`;
      tile.setAttribute('aria-label', `${item.label} status ${rec.status}`);
      tile.addEventListener('click', ()=>{
        rec.status = cycleStatus(rec.status);
        rec.ts = Date.now();
        saveLocal(state);
        queueRemoteSave();
        showTiles();
      });

      const chip = document.createElement('div'); chip.className='status-chip'; chip.textContent = statusChipText(rec.status); tile.appendChild(chip);
      const badge = document.createElement('div'); badge.className='badge'; badge.textContent = rec.status==='green' ? '—' : minutesSince(rec.ts); tile.appendChild(badge);
      const icon = document.createElement('div'); icon.className='icon'; icon.textContent=item.icon; tile.appendChild(icon);
      const label = document.createElement('div'); label.className='label'; label.textContent=item.label; tile.appendChild(label);
      const hint = document.createElement('div'); hint.className='hint'; hint.textContent='Tap to cycle  •  ⟳ Reset'; tile.appendChild(hint);
      const reset = document.createElement('button'); reset.className='reset'; reset.type='button'; reset.textContent='⟳'; reset.setAttribute('aria-label', `Reset ${item.label} to green`);
      reset.addEventListener('click', (ev)=>{ ev.stopPropagation(); rec.status='green'; rec.ts=Date.now(); saveLocal(state); queueRemoteSave(); showTiles(); });
      tile.appendChild(reset);

      tilesScreen.appendChild(tile);
    });
  }

  const clientId = Math.random().toString(36).slice(2);
  let saveTimer = null;
  function queueRemoteSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      const payload = { activeSide: state.activeSide, sides: state.sides, _updatedAt: Date.now(), _by: clientId };
      await setDoc(sessionRef, payload, { merge: true });
    }, 120);
  }

  (async function bootstrap(){
    const snap = await getDoc(sessionRef);
    if(snap.exists()){
      const cloud = snap.data();
      if(cloud?.sides) state.sides = cloud.sides;
      if(cloud?.activeSide) state.activeSide = cloud.activeSide;
      upgradeState(state);
      saveLocal(state);
    } else {
      await setDoc(sessionRef, { activeSide: state.activeSide, sides: state.sides, _createdAt: Date.now(), _by: clientId });
    }
    showTiles();
  })();

  onSnapshot(sessionRef, (snap)=>{
    if(!snap.exists()) return;
    const cloud = snap.data();
    if(cloud._by === clientId) return;
    if(cloud?.sides){ state.sides = cloud.sides; }
    if(cloud?.activeSide){ state.activeSide = cloud.activeSide; }
    upgradeState(state);
    saveLocal(state);
    [...sideTabs.querySelectorAll('.tab')].forEach(t=>{
      t.classList.toggle('active', t.dataset.side===state.activeSide);
      t.setAttribute('aria-selected', t.dataset.side===state.activeSide ? 'true' : 'false');
    });
    showTiles();
  });

  setInterval(()=>{ showTiles(); }, 30000);
  showTiles();
</script>
</body>
</html>
